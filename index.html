<!doctype html>
<html lang="en">
<head>
	<title>Munsell Color Picker</title>
	<script type="text/javascript" src="munsell-floats.js"></script>
	<script type="text/javascript" src="munsell-interpolate.js"></script>
	<script type="text/javascript" src="glue5.js"></script>
	<script type="text/javascript" src="color.js"></script>
	<script type="text/javascript">
		<!--
		function colorname(triple) {
			var ans = [0, 0, 0];
			for (var i in ans) {
				ans[i] = Math.round(triple[i] * 255);
			}
			return Color.cssrgb(ans);
		}
		function color_charted(triple) {
			for (var i in triple) {
				if (isNaN(triple[i])) { return false; }
			}
			return true;
		}
		function color_valid(triple) {
			for (var i in triple) {
				if (triple[i] < 0 || triple[i] > 1) { return false; }
			}
			return true;
		}
		function chroma_map(k) {
			return (k + 1) / 26;
		}
		function lightness_map(i) {
			if (i < 4) { return (i + 1) * 0.02; }
			else { return (i - 3) / 10; }
		}
		function munsell_name(i, j, k) {
			var hue = ((i % 4 + 1) * 2.5).toFixed(1) +
				['R', 'YR', 'Y', 'GY', 'G', 'BG', 'B', 'PB', 'P', 'RP'][
				Math.floor(i/4)
				];
			var lightness = (lightness_map(j) * 10).toFixed(2);
			var chroma = ((k + 1) * 2).toFixed(1);
			return hue + ' ' + lightness + '/' + chroma;
		}
		function drawWedge(ctx, r1, r2, angle1, angle2) {
			ctx.beginPath();
			ctx.moveTo(r1 * Math.cos(angle2), r1 * Math.sin(angle2));
			ctx.arc(0, 0, r1, angle2, angle1, true);
			ctx.lineTo(r2 * Math.cos(angle1), r2 * Math.sin(angle1));
			ctx.arc(0, 0, r2, angle1, angle2, false);
			ctx.closePath();
		}
		function drawCrossHairs(ctx, x, y, r1, r2) {
			ctx.beginPath();
			ctx.moveTo(x - r1, y);
			ctx.lineTo(x - r2, y);
			ctx.moveTo(x + r1, y);
			ctx.lineTo(x + r2, y);
			ctx.moveTo(x, y - r1);
			ctx.lineTo(x, y - r2);
			ctx.moveTo(x, y + r1);
			ctx.lineTo(x, y + r2);
		}
		function drawPolarCrossHairs(ctx, r, angle, r1, r2) {
			return drawCrossHairs(ctx, r * Math.cos(angle), r * Math.sin(angle), r1, r2);
		}
		function draw_selections(ctx, radius) {
			var angle = Math.PI / 20;
			var i = window.current_color[0];
			var j = window.current_color[1];
			var k = window.current_color[2];
			// Draw HC
			ctx.save();
			ctx.translate(3*radius, radius);
			ctx.scale(radius, -radius);
			ctx.lineWidth = 0.0003 * (k+10);
			ctx.strokeStyle = 'rgb(255,255,255)';
			if (is_discrete()) {
				drawWedge(ctx, chroma_map(k), chroma_map(k+1), i*angle, (i+1)*angle);
			} else {
				drawPolarCrossHairs(ctx, chroma_map(k), i*angle, 0.01, 0.05);
			}
			ctx.stroke();
			ctx.restore();
			// Draw HL
			ctx.save();
			ctx.translate(5*radius, radius);
			ctx.scale(radius, -radius);
			ctx.lineWidth = 0.01 * (0.1 + lightness_map(j));
			ctx.strokeStyle = 'rgb(255,255,255)';
			if (is_discrete()) {
				drawWedge(ctx, lightness_map(j-1), lightness_map(j),
					i*angle, (i+1)*angle);
			} else {
				drawPolarCrossHairs(ctx, lightness_map(j-1), i*angle, 0.01, 0.05);
			}
			ctx.stroke();
			ctx.restore();
			// Draw LC
			ctx.save();
			ctx.translate(0, 2*radius);
			ctx.scale(2*radius, -2*radius);
			ctx.lineWidth = 0.005;
			ctx.strokeStyle = 'rgb(255,255,255)';
			if (is_discrete()) {
				ctx.strokeRect(chroma_map(k), lightness_map(j-1),
					chroma_map(k) - chroma_map(k-1),
					lightness_map(j) - lightness_map(j-1));
			} else {
				drawCrossHairs(ctx, chroma_map(k), lightness_map(j-1), 0.005, 0.025);
				ctx.stroke();
			}
			ctx.restore();
		}
		function draw_hc(ctx, radius, j) {
			var angle = Math.PI / 20;
			ctx.save();
			ctx.translate(3*radius, radius);
			ctx.scale(radius, -radius);
			for (var i = 0; i < 40; i++) {
				for (var k = -1; k < 25; k++) {
					var color = Munsell.interpolate(i, j, k);
					if (!color_charted(color)) { color = [0,0,0]; }
					if (!color_valid(color)) { continue; }
					ctx.fillStyle = colorname(color);
					drawWedge(ctx, chroma_map(k), chroma_map(k+1), i*angle, (i+1)*angle);
					ctx.fill();
				}
			}
			ctx.restore();
		}
		function draw_hl(ctx, radius, k) {
			var angle = Math.PI / 20;
			ctx.save();
			ctx.translate(5*radius, radius);
			ctx.scale(radius, -radius);
			for (var i = 0; i < 40; i++) {
				for (var j = 0; j < 14; j++) {
					var color = Munsell.interpolate(i, j, k);
					if (!color_charted(color)) { color = [0,0,0]; }
					if (!color_valid(color)) { continue; }
					ctx.fillStyle = colorname(color);
					drawWedge(ctx, lightness_map(j-1), lightness_map(j),
						i*angle, (i+1)*angle);
					ctx.fill();
				}
			}
			ctx.restore();
		}
		function draw_lc(ctx, radius, i) {
			ctx.save();
			ctx.translate(0, 2*radius);
			ctx.scale(2*radius, -2*radius);
			for (var j = 0; j < 14; j++) {
				for (var k = -1; k < 25; k++) {
					var color = Munsell.interpolate(i, j, k);
					if (!color_charted(color)) { color = [0,0,0]; }
					if (!color_valid(color)) { continue; }
					ctx.fillStyle = colorname(color);
					ctx.fillRect(chroma_map(k), lightness_map(j-1),
						chroma_map(k) - chroma_map(k-1),
						lightness_map(j) - lightness_map(j-1));
				}
			}
			ctx.restore();
		}
		function draw() {
			var m = document.getElementById('main');
			m.width = m.width;
			var c = m.getContext('2d');
			var radius = m.height / 2;
			draw_lc(c, radius, window.current_color[0]);
			draw_hc(c, radius, window.current_color[1]);
			draw_hl(c, radius, window.current_color[2]);
			draw_selections(c, radius);
			show_color_in_elt(window.current_color,
				document.getElementById('selected'),
				document.getElementById('selected_box'));
		}
		function draw_continuous() {
			var m = document.getElementById('main');
			m.width = m.width;
			var c = m.getContext('2d');
			var radius = m.height / 2;
			var w = m.width;
			var h = m.height;
			var d = c.getImageData(0, 0, w, h);
			for (var x = 0; x < w; x++) {
				for (var y = 0; y < h; y++) {
					var i = (x + y * w) * 4;
					var color = get_color(x, y);
					d.data[i] = d.data[i + 1] = d.data[i + 2] = d.data[i + 3] = 0;
					if (color) {
						color = Munsell.interpolate(color[0], color[1], color[2]);
						if (color_valid(color)) {
							d.data[i + 0] = Math.round(color[0] * 255);
							d.data[i + 1] = Math.round(color[1] * 255);
							d.data[i + 2] = Math.round(color[2] * 255);
							d.data[i + 3] = 255;
						}
					}
				}
			}
			d = c.putImageData(d, 0, 0);
			draw_selections(c, radius);
			show_color_in_elt(window.current_color,
				document.getElementById('selected'),
				document.getElementById('selected_box'));
		}
		function get_color(x, y) {
			var m = document.getElementById('main');
			var radius = m.height / 2;
			var i, j, k;
			if (x < 2 * radius) {
				x = x/(2 * radius);
				y = 1 - y/(2 * radius);
				i = window.current_color[0];
				if (y < 0.1) {
					j = y * 50;
				} else {
					j = y * 10 + 4;
				}
				k = x * 26 - 1;
			} else if ( x < 4 * radius ) {
				x = x/radius - 3;
				y = 1 - y/radius;
				i = Math.atan2(y, x) * 20 / Math.PI;
				i = (i + 40) % 40;
				j = window.current_color[1];
				k = Math.sqrt(x*x + y*y) * 26 - 1;
			} else {
				x = x/radius - 5;
				y = 1 - y/radius;
				i = Math.atan2(y, x) * 20 / Math.PI;
				i = (i + 40) % 40;
				j = Math.sqrt(x*x + y*y);
				if (j < 0.1) {
					j = j * 50;
				} else {
					j = j * 10 + 4;
				}
				k = window.current_color[2];
			}
			if (i < 0 || j < 0 || k < -1) { return; }
			if (i >= 40 || j >= 14 || k >= 25) { return; }
			return [i, j, k];
		}
		function is_discrete() {
			return document.getElementById('discrete_check').checked;
		}
		function show_color_in_elt(color, elt, showbox) {
			if (!color) { return; }
			var ans = munsell_name(color[0], color[1], color[2]);
			var rgb = Munsell.interpolate(color[0], color[1], color[2]);
			var rgbname = colorname(rgb);
			if (color_charted(rgb)) {
				if (color_valid(rgb)) {
					ans += ' ' + rgbname;
				} else {
					ans += ' <span class="warning">' + rgbname + '</span>';
				}
			} else {
				ans += ' <span class="error">(Uncharted)</span>';
			}
			elt.innerHTML = ans;
			showbox.style.background = rgbname;
		}
		window.onload = function () {
			// Set up the canvas
			var width = document.body.clientWidth;
			var m = document.getElementById('main');
			m.width = width;
			m.height = Math.floor(width / 3);
			// Pick initial color and draw once
			window.current_color = [30, 8, 4]; // h, l, c
			draw();
			// Having drawn once, set up event handlers
			m.onmousemove = function (e) {
				if (!e) { e = window.event; }
				var xy = mouse_coords(e);
				var color = get_color(xy[0] - m.offsetLeft, xy[1] - m.offsetTop);
				if (is_discrete()) {
					for (var i in color) {
						color[i] = Math.floor(color[i]);
					}
				}
				if (window.mouse_is_down) {
					if (color && (window.current_color != color)) {
						window.current_color = color;
						draw();
					}
				}
				show_color_in_elt(color,
					document.getElementById('mouseover'),
					document.getElementById('mouseover_box'));
			}
			window.onresize = function () {
				var width = document.body.clientWidth;
				var m = document.getElementById('main');
				m.width = width;
				m.height = Math.floor(width / 3);
				draw();
			}
			window.onmousedown = function (e) {
				window.mouse_is_down = true;
				document.getElementById('main').onmousemove(e);
			}
			window.onmouseup = function () { window.mouse_is_down = false; }
			m.onmouseout = function () { window.mouse_is_down = false; }
			document.getElementById('continuous_button').onclick = function () {
				var button = this;
				function draw_continuous_finish() {
					draw_continuous();
					button.disabled = false;
				}
				button.disabled = true;
				setTimeout(draw_continuous_finish, 25);
			}
		};
		//-->
	</script>
	<style type="text/css">
		body{ 
			background: #000;
			color: #fff;
			text-align: center;
		}
		canvas {
			display: block;
			margin-left: auto;
			margin-right: auto;
			margin-bottom: 0.5em;
			background: #777;
			border: 1px solid #333;
		}
		span#mouseover_box, span#selected_box {
			display: inline-block;
			overflow: hidden;
			width: 1em;
			height: 1em;
			border: 1px dotted #fff;
		}
		div#selected_div {
			text-align: right;
		}
		div#discrete_check_div {
			float: left;
		}
		span.warning {
			color: #fc0;
		}
		span.error {
			color: #f66;
		}
	</style>
</head>
<body>
	<canvas id="main" width="300" height="300"></canvas>
	<div id="discrete_check_div">
		<div>
			<input type="checkbox" id="discrete_check" checked />
			<label for="discrete_check">Select discrete</label>
		</div>
		<div>
			<input type="button" id="continuous_button" value="Render interpolated" />
		</div>
	</div>
	<div id="selected_div">
		<div>Selected:
			<span id="selected">None</span>
			<span id="selected_box">&nbsp;</span>
		</div>
		<div>Mouse over:
			<span id="mouseover">None</span>
			<span id="mouseover_box">&nbsp;</span>
		</div>
	</div>
</body>
</html>
